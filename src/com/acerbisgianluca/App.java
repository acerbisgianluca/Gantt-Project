package com.acerbisgianluca;

import com.acerbisgianluca.exceptions.TaskAlreadyExistsException;
import com.acerbisgianluca.exceptions.TaskNotFoundException;
import com.acerbisgianluca.filemanager.FileManager;
import java.awt.Color;
import java.awt.Desktop;
import java.awt.event.KeyEvent;
import java.io.File;
import java.io.IOException;
import java.net.MalformedURLException;
import java.net.URISyntaxException;
import java.net.URL;
import java.time.LocalDate;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import javax.swing.DefaultListModel;
import javax.swing.ImageIcon;
import javax.swing.JFileChooser;
import javax.swing.filechooser.FileFilter;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableRowSorter;

/**
 * E' la classe principale che non viene instanziata e che contiene i metodi
 * principali. Gestisce tutta la comunicazione con l'utente raccogliendo tutti i
 * dati sulle attività.
 *
 * @author Gianluca
 */
public class App extends javax.swing.JFrame {

    /**
     * Il modello della tabella.
     */
    private final DefaultTableModel tableModel;
    /**
     * Il modello della lista di possibili dipendenze.
     */
    private final DefaultListModel<String> listModel;
    /**
     * L'oggetto che contiene i metodi per eseguire l'algoritmo.
     */
    private Algorithm algorithm;
    /**
     * Indica se si sta modificando un {@link com.acerbisgianluca.Task} già
     * esistente.
     */
    private boolean editing;
    /**
     * Il nome precedente del {@link com.acerbisgianluca.Task} che si sta
     * modificando.
     */
    private String lastName;
    /**
     * Formattatore per le date da stringa a oggetto e viceversa.
     */
    private final DateTimeFormatter fmt;

    /**
     * Creates new form App
     */
    public App() {
        initComponents();
        tableModel = (DefaultTableModel) table.getModel();
        listModel = new DefaultListModel<>();
        listDependencies.setModel(listModel);
        algorithm = new Algorithm();
        editing = false;
        this.fmt = DateTimeFormatter.ofPattern("dd/MMM/yyyy");
        cleanFields(true);
        setRowSorter();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        panel = new javax.swing.JPanel();
        lblAddTask = new javax.swing.JLabel();
        lblName = new javax.swing.JLabel();
        txtName = new javax.swing.JTextField();
        lblDuration = new javax.swing.JLabel();
        spnDuration = new javax.swing.JSpinner();
        lblStartDate = new javax.swing.JLabel();
        spnDate = new javax.swing.JSpinner();
        lblDependencies = new javax.swing.JLabel();
        listScrollPane = new javax.swing.JScrollPane();
        listDependencies = new javax.swing.JList<>();
        btnAdd = new javax.swing.JButton();
        btnDeleteTask = new javax.swing.JButton();
        btnDeleteAll = new javax.swing.JButton();
        separator = new javax.swing.JSeparator();
        tableScrollPane = new javax.swing.JScrollPane();
        table = new javax.swing.JTable();
        lblOutput = new javax.swing.JLabel();
        menuBar = new javax.swing.JMenuBar();
        file = new javax.swing.JMenu();
        btnSave = new javax.swing.JMenuItem();
        btnLoad = new javax.swing.JMenuItem();
        btnExit = new javax.swing.JMenuItem();
        help = new javax.swing.JMenu();
        github = new javax.swing.JMenuItem();
        tutorial = new javax.swing.JMenuItem();
        bugReport = new javax.swing.JMenuItem();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setTitle("Gantt Project");
        setResizable(false);

        lblAddTask.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        lblAddTask.setText("Aggiungi una nuova attività");

        lblName.setText("Nome");

        lblDuration.setText("Durata");

        spnDuration.setModel(new javax.swing.SpinnerNumberModel(1, 1, null, 1));

        lblStartDate.setText("Data di inizio");

        spnDate.setModel(new javax.swing.SpinnerDateModel());

        lblDependencies.setText("Precedenze");

        listDependencies.setLayoutOrientation(javax.swing.JList.VERTICAL_WRAP);
        listScrollPane.setViewportView(listDependencies);

        btnAdd.setText("Aggiungi");
        btnAdd.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnAddActionPerformed(evt);
            }
        });

        btnDeleteTask.setText("Elimina attività");
        btnDeleteTask.setEnabled(false);
        btnDeleteTask.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnDeleteTaskActionPerformed(evt);
            }
        });

        btnDeleteAll.setText("Elimina tutto");
        btnDeleteAll.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnDeleteAllActionPerformed(evt);
            }
        });

        table.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Nome", "Durata", "Early Start", "Early Finish", "Late Start", "Late Finish"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.String.class, java.lang.Integer.class, java.lang.String.class, java.lang.String.class, java.lang.String.class, java.lang.String.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        table.setDragEnabled(true);
        table.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        table.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                tableMouseClicked(evt);
            }
        });
        table.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                tableKeyPressed(evt);
            }
        });
        tableScrollPane.setViewportView(table);

        lblOutput.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N

        javax.swing.GroupLayout panelLayout = new javax.swing.GroupLayout(panel);
        panel.setLayout(panelLayout);
        panelLayout.setHorizontalGroup(
            panelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(panelLayout.createSequentialGroup()
                .addGroup(panelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(panelLayout.createSequentialGroup()
                        .addContainerGap()
                        .addGroup(panelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(panelLayout.createSequentialGroup()
                                .addComponent(lblName)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(txtName, javax.swing.GroupLayout.PREFERRED_SIZE, 132, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(lblDuration)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(spnDuration, javax.swing.GroupLayout.PREFERRED_SIZE, 55, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(lblStartDate)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(spnDate, javax.swing.GroupLayout.PREFERRED_SIZE, 112, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(lblDependencies)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(listScrollPane, javax.swing.GroupLayout.PREFERRED_SIZE, 85, javax.swing.GroupLayout.PREFERRED_SIZE))
                            .addComponent(lblAddTask)
                            .addComponent(tableScrollPane, javax.swing.GroupLayout.PREFERRED_SIZE, 536, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addGroup(panelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(btnAdd, javax.swing.GroupLayout.PREFERRED_SIZE, 83, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(btnDeleteTask)
                            .addComponent(btnDeleteAll)))
                    .addComponent(separator, javax.swing.GroupLayout.PREFERRED_SIZE, 546, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(0, 10, Short.MAX_VALUE))
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, panelLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(lblOutput, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );
        panelLayout.setVerticalGroup(
            panelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(panelLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(lblAddTask)
                .addGap(10, 10, 10)
                .addGroup(panelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(panelLayout.createSequentialGroup()
                        .addGroup(panelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(txtName, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(lblName)
                            .addComponent(lblDuration)
                            .addComponent(spnDuration, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(lblStartDate)
                            .addComponent(lblDependencies)
                            .addComponent(spnDate, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(separator, javax.swing.GroupLayout.PREFERRED_SIZE, 10, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(tableScrollPane, javax.swing.GroupLayout.PREFERRED_SIZE, 385, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(panelLayout.createSequentialGroup()
                        .addGap(1, 1, 1)
                        .addGroup(panelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(panelLayout.createSequentialGroup()
                                .addComponent(btnAdd)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(btnDeleteTask)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(btnDeleteAll))
                            .addComponent(listScrollPane, javax.swing.GroupLayout.PREFERRED_SIZE, 427, javax.swing.GroupLayout.PREFERRED_SIZE))))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(lblOutput, javax.swing.GroupLayout.PREFERRED_SIZE, 23, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        file.setText("File");

        btnSave.setAccelerator(javax.swing.KeyStroke.getKeyStroke(java.awt.event.KeyEvent.VK_S, java.awt.event.InputEvent.CTRL_MASK));
        btnSave.setText("Salva");
        btnSave.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSaveActionPerformed(evt);
            }
        });
        file.add(btnSave);

        btnLoad.setAccelerator(javax.swing.KeyStroke.getKeyStroke(java.awt.event.KeyEvent.VK_L, java.awt.event.InputEvent.CTRL_MASK));
        btnLoad.setText("Carica");
        btnLoad.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnLoadActionPerformed(evt);
            }
        });
        file.add(btnLoad);

        btnExit.setAccelerator(javax.swing.KeyStroke.getKeyStroke(java.awt.event.KeyEvent.VK_Q, java.awt.event.InputEvent.CTRL_MASK));
        btnExit.setText("Esci");
        btnExit.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnExitActionPerformed(evt);
            }
        });
        file.add(btnExit);

        menuBar.add(file);

        help.setText("Aiuto");

        github.setText("Github Repository");
        github.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                githubActionPerformed(evt);
            }
        });
        help.add(github);

        tutorial.setText("Guida");
        tutorial.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                tutorialActionPerformed(evt);
            }
        });
        help.add(tutorial);

        bugReport.setText("Segnala un bug");
        bugReport.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                bugReportActionPerformed(evt);
            }
        });
        help.add(bugReport);

        menuBar.add(help);

        setJMenuBar(menuBar);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(panel, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(panel, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
        );

        pack();
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    /**
     * Contiene l'algoritmo e i check per aggiungere/modificare un
     * {@link com.acerbisgianluca.Task}.
     *
     * @param evt L'evento generato al click del bottone per
     * aggiungere/modificare un {@link com.acerbisgianluca.Task}.
     */
    private void btnAddActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnAddActionPerformed
        Task newESEF, newLSLF, tESEF, tLSLF;
        try {
            if (editing) {

                String name = txtName.getText().trim();
                if (name.equals("")) {
                    showMessage("Inserire il nome.", true);
                    return;
                }
                if (!this.lastName.equals(name)) {
                    taskExists(name);
                }

                newLSLF = algorithm.getTaskByName(this.lastName, false);
                newESEF = algorithm.getTaskByName(this.lastName, true);

                Date date = (Date) spnDate.getModel().getValue();
                LocalDate localDate = date.toInstant().atZone(ZoneId.systemDefault()).toLocalDate();

                int duration = (int) spnDuration.getModel().getValue();
                duration = duration < 1 ? 1 : duration;

                int[] dependenciesIds = listDependencies.getSelectedIndices();
				for(int i : dependenciesIds){
                    if (algorithm.getTaskByName(listModel.getElementAt(i), true).getDependencies().contains(newESEF)) {
                        showMessage("Rilevato ciclo fra " + listModel.getElementAt(i) + " e " + name + " (nome precedente: " + this.lastName + ") attività.", true);
                        return;
                    }
                }
                for (int i : dependenciesIds) {
                    if (i == 0 || listModel.getElementAt(i).equals(this.lastName)) {
                        continue;
                    }

                    if (!newESEF.getDependencies().contains((tESEF = algorithm.getTaskByName(listModel.getElementAt(i), true)))) {
                        newESEF.addDependency(tESEF);
                        newLSLF.addDependency((tLSLF = algorithm.getTaskByName(listModel.getElementAt(i), false)));

                        tESEF.addParent(newESEF);
                        tLSLF.addParent(newLSLF);
                    }
                }

                newLSLF.update(name, localDate, duration);
                newESEF.update(name, localDate, duration);
                showResult();

                for (int i = 0; i < listModel.size(); i++) {
                    if (listModel.getElementAt(i).equals(this.lastName)) {
                        listModel.set(i, name);
                        break;
                    }
                }

                for (int i = 1; i < listModel.size(); i++) {
                    if (!listDependencies.isSelectedIndex(i)) {
                        if (newESEF.getDependencies().contains((tESEF = algorithm.getTaskByName(listModel.getElementAt(i), true)))) {
                            newESEF.removeDependency(tESEF);
                            newLSLF.removeDependency((tLSLF = algorithm.getTaskByName(listModel.getElementAt(i), false)));

                            tESEF.removeParent(newESEF);
                            tLSLF.removeParent(newLSLF);
                        }
                    }
                }

                cleanFields(false);
                realTimeRun();
                return;
            }

            String name = txtName.getText().trim();
            if (name.equals("")) {
                showMessage("Inserire il nome.", true);
                return;
            }
            taskExists(name);

            Date date = (Date) spnDate.getModel().getValue();
            LocalDate localDate = date.toInstant().atZone(ZoneId.systemDefault()).toLocalDate();

            int duration = (int) spnDuration.getModel().getValue();
            duration = duration < 1 ? 1 : duration;

            newESEF = new Task(name, localDate, duration);
            newLSLF = new Task(name, localDate, duration);

            int[] dependenciesIds = listDependencies.getSelectedIndices();
            for (int i : dependenciesIds) {
                if (i == 0) {
                    continue;
                }

                tESEF = algorithm.getTaskByName(listModel.getElementAt(i), true);
                tLSLF = algorithm.getTaskByName(listModel.getElementAt(i), false);

                newESEF.addDependency(tESEF);
                newLSLF.addDependency(tLSLF);

                tESEF.addParent(newESEF);
                tLSLF.addParent(newLSLF);

            }

            algorithm.addTask(newESEF, true);
            algorithm.addTask(newLSLF, false);

            listModel.addElement(name);

            tableModel.addRow(new Object[]{name, duration, newESEF.getStart().format(this.fmt), newESEF.getEnd().format(this.fmt), newLSLF.getStart().format(this.fmt), newLSLF.getEnd().format(this.fmt)});
            cleanFields(false);
            realTimeRun();
        } catch (TaskNotFoundException | TaskAlreadyExistsException ex) {
            showMessage(ex.getMessage(), true);
        }
    }//GEN-LAST:event_btnAddActionPerformed

    /**
     * Elimina tutti i {@link com.acerbisgianluca.Task}, resetta la tabella e i
     * campi.
     *
     * @param evt L'evento generato al click sul bottone per eliminare tutti i
     * {@link com.acerbisgianluca.Task}.
     */
    private void btnDeleteAllActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnDeleteAllActionPerformed
        if (algorithm.getTasksESEF().isEmpty()) {
            showMessage("Non è stata ancora inserita alcuna attività.", true);
            return;
        }
        algorithm.resetLists();
        tableModel.setRowCount(0);
        listModel.clear();
        cleanFields(true);
    }//GEN-LAST:event_btnDeleteAllActionPerformed

    /**
     * Elimina l'attività dalle liste, dalla tabella, dalla lista di dipendenze
     * e da tutte le attività ad essa collegate.
     *
     * @param evt L'evento generato al click sul bottone per eliminare
     * un'attività.
     */
    private void btnDeleteTaskActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnDeleteTaskActionPerformed
        int row = table.getSelectedRow();
        String name = (String) table.getValueAt(row, 0);
        Task tESEF, tLSLF;
        try {
            tESEF = algorithm.getTaskByName(name, true);
            tLSLF = algorithm.getTaskByName(name, false);

            tESEF.getDependencies().forEach((t) -> {
                t.removeParent(tESEF);
            });
            tESEF.getParents().forEach((t) -> {
                t.removeDependency(tESEF);
            });
            tLSLF.getDependencies().forEach((t) -> {
                t.removeParent(tLSLF);
            });
            tLSLF.getParents().forEach((t) -> {
                t.removeDependency(tLSLF);
            });

            algorithm.removeFromLists(tESEF, tLSLF);
        } catch (TaskNotFoundException ex) {
            showMessage(ex.getMessage(), true);
        }

        tableModel.removeRow(row);
        listModel.removeElement(name);

        cleanFields(false);
        if (!this.algorithm.getTasksESEF().isEmpty()) {
            realTimeRun();
        }
    }//GEN-LAST:event_btnDeleteTaskActionPerformed

    /**
     * Carica nel form i dati del {@link com.acerbisgianluca.Task} selezionato.
     *
     * @param evt L'evento generato al click su di una riga della tabella.
     */
    private void tableMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_tableMouseClicked
        editing = true;
        lblAddTask.setText("Modifica l'attività selezionata");
        btnAdd.setText("Modifica");
        btnDeleteTask.setEnabled(true);

        try {
            int row = table.getSelectedRow();
            String name = (String) table.getValueAt(row, 0);
            this.lastName = name;
            txtName.setText(name);
            spnDuration.setValue((int) table.getValueAt(row, 1));
            spnDate.setValue(java.sql.Date.valueOf(algorithm.getTaskByName(name, true).getDefaultDate()));
            Task tLSLF = algorithm.getTaskByName(name, false);
            List<Integer> selectedIndeces = new ArrayList<>();
            for (int i = 0; i < listModel.size(); i++) {
                for (int j = 0; j < tLSLF.getDependencies().size(); j++) {
                    if (tLSLF.getDependencies().get(j).getName().equals(listModel.getElementAt(i))) {
                        selectedIndeces.add(i);
                    }
                }
            }
            int[] selectedIndicesArr = new int[selectedIndeces.size()];
            int i = 0;
            for (Integer n : selectedIndeces) {
                selectedIndicesArr[i] = n;
                i++;
            }
            listDependencies.clearSelection();
            if (selectedIndeces.isEmpty()) {
                listDependencies.setSelectedIndex(0);
            } else {
                listDependencies.setSelectedIndices(selectedIndicesArr);
            }
        } catch (TaskNotFoundException ex) {
            showMessage(ex.getMessage(), true);
        }
    }//GEN-LAST:event_tableMouseClicked

    /**
     * Blocca la propagazione del click delle frecce verso l'alto e il basso per
     * evitare bug con la tabella.
     *
     * @param evt L'evente generato al click di un tasto della tastiera.
     */
    private void tableKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_tableKeyPressed
        if (evt.getKeyCode() == KeyEvent.VK_UP || evt.getKeyCode() == KeyEvent.VK_DOWN) {
            evt.consume();
        }
    }//GEN-LAST:event_tableKeyPressed

    /**
     * Salva su file l'intero oggetto che contiene l'agoritmo e quindi le 2
     * liste.
     *
     * @param evt L'evento generato al clic sul pulsante di salvataggio.
     */
    private void btnSaveActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSaveActionPerformed
        try {
            JFileChooser fc = new JFileChooser(System.getProperty("user.dir"));
            fc.setFileFilter(fileFilter);
            fc.showSaveDialog(this);
            File selecedFile = fc.getSelectedFile();
            if(selecedFile == null){
                showMessage("Seleziona un file da caricare.", true);
                return;
            }
                
            this.algorithm = (Algorithm) FileManager.fileToObject(selecedFile.getAbsolutePath());
            showMessage("Salvataggio avvenuto con successo.", false);
        } catch (IOException ex) {
            showMessage("Errore nel salvataggio del file.", true);
        }
    }//GEN-LAST:event_btnSaveActionPerformed

    /**
     * Carica da file l'intero oggetto che contiene l'agoritmo e quindi le 2
     * liste. Riempie la lista di dipendenze e la tabella.
     *
     * @param evt L'evento generato al clic sul pulsante di caricamento.
     */
    private void btnLoadActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnLoadActionPerformed
        try {
            JFileChooser fc = new JFileChooser(System.getProperty("user.dir"));
            fc.setFileFilter(fileFilter);
            fc.showOpenDialog(this);
            File selecedFile = fc.getSelectedFile();
            if(selecedFile == null){
                showMessage("Seleziona un file da caricare.", true);
                return;
            }
                
            this.algorithm = (Algorithm) FileManager.fileToObject(selecedFile.getAbsolutePath());
            this.algorithm.getTasksESEF().forEach((t) -> {
                listModel.addElement(t.getName());
            });

            showResult();
            showMessage("File caricato con successo.", false);
        } catch (IOException | ClassNotFoundException ex) {
            showMessage("Errore nella lettura del file. Se non hai ancora salvato, fallo!", true);
        }
    }//GEN-LAST:event_btnLoadActionPerformed

    /**
     * Chiude il programma.
     *
     * @param evt L'evento generato al clic sul pulsante di chiusura.
     */
    private void btnExitActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnExitActionPerformed
        System.exit(0);
    }//GEN-LAST:event_btnExitActionPerformed

    /**
     * Apre nel browser predefinito la repository di Github.
     *
     * @param evt L'evento generato al clic sul pulsante di apertura di Github.
     */
    private void githubActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_githubActionPerformed
        try {
            openBrowser(new URL("https://github.com/acerbisgianluca/Gantt-Project"));
        } catch (MalformedURLException ex) {
            showMessage("Impossibile aprire il browser.", true);
        }
    }//GEN-LAST:event_githubActionPerformed

    /**
     * Apre nel browser predefinito la wiki del progetto su Github.
     *
     * @param evt L'evento generato al clic sul pulsante di apertura di Github.
     */
    private void tutorialActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_tutorialActionPerformed
        try {
            openBrowser(new URL("https://github.com/acerbisgianluca/Gantt-Project/wiki"));
        } catch (MalformedURLException ex) {
            showMessage("Impossibile aprire il browser.", true);
        }
    }//GEN-LAST:event_tutorialActionPerformed

    /**
     * Apre nel browser predefinito gli issues del progetto su Github.
     *
     * @param evt L'evento generato al clic sul pulsante di apertura di Github.
     */
    private void bugReportActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_bugReportActionPerformed
        try {
            openBrowser(new URL("https://github.com/acerbisgianluca/Gantt-Project/issues"));
        } catch (MalformedURLException ex) {
            showMessage("Impossibile aprire il browser.", true);
        }
    }//GEN-LAST:event_bugReportActionPerformed

    /**
     * Recupera il browser predefinito dell'utente e apre il link passato come
     * argomento.
     *
     * @param url L'url da aprire nel browser.
     */
    private void openBrowser(URL url) {
        Desktop desktop = Desktop.isDesktopSupported() ? Desktop.getDesktop() : null;
        if (desktop != null && desktop.isSupported(Desktop.Action.BROWSE)) {
            try {
                desktop.browse(url.toURI());
            } catch (IOException | URISyntaxException e) {
                showMessage("Impossibile aprire il browser.", true);
            }
        }
    }

    /**
     * Crea le righe all'interno della tabella indicando nome, durata, data di
     * inizio ES, data di fine EF, data di inizio LS e data di fine LF di ogni
     * attività.
     */
    public void showResult() {
        List<Task> esef = algorithm.getTasksESEF();
        List<Task> lslf = algorithm.getTasksLSLF();
        Task t, t1;
        tableModel.setRowCount(0);
        for (int i = 0; i < esef.size(); i++) {
            t = esef.get(i);
            t1 = lslf.get(i);
            tableModel.addRow(new Object[]{t.getName(), t.getDuration(), t.getStart().format(this.fmt), t.getEnd().format(this.fmt), t1.getStart().format(this.fmt), t1.getEnd().format(this.fmt)});
        }
    }

    /**
     * Pulisce tutti i campi del form.
     *
     * @param starting Vero se l'applicazione è appena stata avviata, altrimenti
     * false.
     */
    private void cleanFields(boolean starting) {
        txtName.setText("");
        spnDuration.setValue(1);
        spnDate.setValue(new Date());
        showMessage("", false);
        if (starting) {
            listModel.addElement("Nessuna");
        }
        listDependencies.setSelectedIndex(0);
        if (editing) {
            editing = false;
            lblAddTask.setText("Aggiungi una nuova attività");
            btnAdd.setText("Aggiungi");
            btnDeleteTask.setEnabled(false);
        }
    }

    /**
     * Controlla se un {@link com.acerbisgianluca.Task} esiste già.
     *
     * @param name Il nome del nuovo {@link com.acerbisgianluca.Task}.
     * @throws TaskAlreadyExistsException Se il {@link com.acerbisgianluca.Task}
     * esiste già lancia la l'eccezione.
     */
    private void taskExists(String name) throws TaskAlreadyExistsException {
        for (Task t : algorithm.getTasksESEF()) {
            if (t.getName().equalsIgnoreCase(name)) {
                throw new TaskAlreadyExistsException("Un'attività con lo stesso nome esiste già.");
            }
        }
    }

    /**
     * Riesegue l'algoritmo sull'aggiunta o la modifica di un
     * {@link com.acerbisgianluca.Task}.
     */
    private void realTimeRun() {
        algorithm.resetForRunning();
        int totalDuration = algorithm.run();
        showMessage("La durata totale del ciclo di attività è di " + totalDuration + " giorni.", false);
        showResult();
    }

    /**
     * Imposta il comparatore per l'ordinamento delle colonne della tabella che
     * contengono una data.
     */
    private void setRowSorter() {
        TableRowSorter tableRowSorter = new TableRowSorter(tableModel);
        DateComparator dateComparator = new DateComparator();
        tableRowSorter.setComparator(2, dateComparator);
        tableRowSorter.setComparator(3, dateComparator);
        tableRowSorter.setComparator(4, dateComparator);
        tableRowSorter.setComparator(5, dateComparator);
        table.setRowSorter(tableRowSorter);
    }

    /**
     * Mostra il messaggio passato come argomento nella label posta sotto la
     * tabella.
     *
     * @param message Il messaggio da mostrare.
     * @param error Vero se è un errore, falso altrimenti.
     */
    private void showMessage(String message, boolean error) {
        if (error) {
            lblOutput.setForeground(Color.red);
        } else {
            lblOutput.setForeground(Color.black);
        }

        lblOutput.setText(message);
    }

    /**
     * Inizializza l'interfaccia grafica ed imposta il titolo.
     *
     * @param args I parametri passati all'interno della linea di comando.
     */
    public static void main(String args[]) {
        /* Set the Windows look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Windows".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException | InstantiationException | IllegalAccessException | javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(App.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>

        //</editor-fold>

        /* Create and display the form */
        java.awt.EventQueue.invokeLater(() -> {
            App app = new App();
            URL url = App.class.getResource("/resources/img/logo.png");
            ImageIcon img = new ImageIcon(url);
            app.setIconImage(img.getImage());
            app.setVisible(true);
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnAdd;
    private javax.swing.JButton btnDeleteAll;
    private javax.swing.JButton btnDeleteTask;
    private javax.swing.JMenuItem btnExit;
    private javax.swing.JMenuItem btnLoad;
    private javax.swing.JMenuItem btnSave;
    private javax.swing.JMenuItem bugReport;
    private javax.swing.JMenu file;
    private javax.swing.JMenuItem github;
    private javax.swing.JMenu help;
    private javax.swing.JLabel lblAddTask;
    private javax.swing.JLabel lblDependencies;
    private javax.swing.JLabel lblDuration;
    private javax.swing.JLabel lblName;
    private javax.swing.JLabel lblOutput;
    private javax.swing.JLabel lblStartDate;
    private javax.swing.JList<String> listDependencies;
    private javax.swing.JScrollPane listScrollPane;
    private javax.swing.JMenuBar menuBar;
    private javax.swing.JPanel panel;
    private javax.swing.JSeparator separator;
    private javax.swing.JSpinner spnDate;
    private javax.swing.JSpinner spnDuration;
    private javax.swing.JTable table;
    private javax.swing.JScrollPane tableScrollPane;
    private javax.swing.JMenuItem tutorial;
    private javax.swing.JTextField txtName;
    // End of variables declaration//GEN-END:variables
}
